#!/bin/bash

CONFIG_FILE="/usr/local/etc/xray/config/04_inbounds.json"

# Lebar kolom
USER_WIDTH=25
DAYS_WIDTH=10
NUM_WIDTH=3

# Fungsi untuk mencetak garis pemisah tabel
print_separator() {
    printf "+-%s-+-%s-+-%s-+\n" \
        "$(printf '%*s' "$NUM_WIDTH" | tr ' ' '-')" \
        "$(printf '%*s' "$USER_WIDTH" | tr ' ' '-')" \
        "$(printf '%*s' "$DAYS_WIDTH" | tr ' ' '-')"
}

# Header
print_separator
printf "| %-*s | %-*s | %-*s |\n" "$NUM_WIDTH" "No" "$USER_WIDTH" "User" "$DAYS_WIDTH" "Expired"
print_separator

# Array untuk menyimpan user
users=()
index=0

# Proses file tanpa subshell
declare -A processed_users

while IFS= read -r line; do
    if [[ "$line" == *"###"* ]]; then
        USER=$(awk '{print $2}' <<< "$line")
        EXPIRY_DATE=$(awk '{print $3}' <<< "$line")

        [[ -z "$USER" ]] && continue
        [[ -n "${processed_users[$USER]}" ]] && continue
        processed_users[$USER]=1

        if [[ -n "$EXPIRY_DATE" ]] && date -d "$EXPIRY_DATE" >/dev/null 2>&1; then
            TODAY_EPOCH=$(date +%s)
            EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
            DAYS_LEFT=$(( (EXPIRY_EPOCH - TODAY_EPOCH) / 86400 ))
            (( DAYS_LEFT < 0 )) && DAYS_LEFT=0
            EXPIRED_TEXT="${DAYS_LEFT} Days"
        else
            EXPIRED_TEXT="Invalid"
        fi

        printf "| %-*s | %-*s | %-*s |\n" "$NUM_WIDTH" "$((++index))" "$USER_WIDTH" "$USER" "$DAYS_WIDTH" "$EXPIRED_TEXT"
        users+=("$USER")
    fi
done < "$CONFIG_FILE"

# Footer
print_separator

# Tampilkan prompt jika ada user
if (( ${#users[@]} > 0 )); then
    echo
    read -p "Pilih nomor user untuk menampilkan nama: " choice

    if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#users[@]} )); then
        selected_user="${users[$((choice - 1))]}"
        echo "User yang dipilih: $selected_user"
    else
        echo "Pilihan tidak valid."
    fi
else
    echo "Tidak ada user ditemukan."
fi
