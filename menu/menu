#!/bin/bash

clear
# Warna untuk output (sesuaikan dengan kebutuhan)
NC='\e[0m'       # No Color (mengatur ulang warna teks ke default)
DEFBOLD='\e[39;1m' # Default Bold
RB='\e[31;1m'    # Red Bold
GB='\e[32;1m'    # Green Bold
YB='\e[33;1m'    # Yellow Bold
BB='\e[34;1m'    # Blue Bold
MB='\e[35;1m'    # Magenta Bold
CB='\e[36;1m'    # Cyan Bold
WB='\e[37;1m'    # White Bold

get_info() {
# Ambil informasi IP dan tanggal dari URL
url="https://raw.githubusercontent.com/Sandhj/registrasi-ip/main/IP"
ip_date=$(curl -s $url)

# Ambil IP dan Tanggal dari data yang diambil
ip=$(echo $ip_date | awk '{print $1}')
date=$(echo $ip_date | awk '{print $2}')

# Ambil IP dan Tanggal hari ini
current_ip=$(curl -s https://ipinfo.io/ip)
current_date=$(date +%Y-%m-%d)

# Hitung tanggal satu hari setelah tanggal hari ini
expiry_date=$(date -d "$date" +%Y-%m-%d)

# Hitung sisa hari hingga kedaluwarsa
remaining_days=$(( ($(date -d "$expiry_date" +%s) - $(date -d "$current_date" +%s)) / 86400 ))

# Periksa apakah IP cocok dan apakah tanggal tidak kadaluarsa
if [[ "$current_ip" == "$ip" && ( "$date" == "$current_date" || "$remaining_days" -ge 0 ) ]]; then
    echo " SAN TUNNEL"
else
    echo "————————————————————————————————————"
    echo "           ${RB}Eror Massage !! ${NC} "
    echo "————————————————————————————————————"
    echo "${GB}     IP Anda Belum Terdaftar/Expired Untuk"
    echo "   Menggunakan Script ini Silahkan "
    echo "            Registrasi ke ${NC}          "
    echo "  Tele : Sanmaxx | Wa : 085155208019"
    echo "————————————————————————————————————"
    exit 1
fi
}

#Periksa apakah User Adalah Admin
# Path file yang akan dicek
file_path="/usr/local/etc/xray/admin"

# Mengecek apakah file ada
if [ -f "$file_path" ]; then
    Admin="∞"
else
    get_info
fi

config_file="/usr/local/etc/xray/config/04_inbounds.json"

vmess_count=$(awk '/###/ {count++} END {print count+0}' "$config_file" 2>/dev/null)
vless_count=$(awk '/##!/ {count++} END {print count+0}' "$config_file" 2>/dev/null)
trojan_count=$(awk '/#&!/ {count++} END {print count+0}' "$config_file" 2>/dev/null)
ss_count=$(awk '/##@/ {count++} END {print count+0}' "$config_file" 2>/dev/null)

vmess=$(( vmess_count / 3 ))
vless=$(( vless_count / 4 ))
trojan=$(( trojan_count / 6 ))
ss=$(( ss_count / 6 ))

# Fungsi untuk memeriksa status layanan
check_service() {
    local service_name=$1
    if systemctl is-active --quiet "$service_name"; then
        echo "${GB}Good${NC}"
    else
        echo "${RB}Eror${NC}"
    fi
}

#Ambil Info Uptime VPS
uptime_info=$(uptime -p)

clear
LAYOUT="
  ${BB}————————————————————————————————${NC}
            ${CB}SAN TUNNELING${NC}
  ${BB}————————————————————————————————${NC}
  Xray Service : $(check_service xray.service)
  Wireproxy    : $(check_service wireproxy.service)
  Nginx        : $(check_service nginx)
  ${BB}————————————————————————————————${NC}
       ${GB}Vmess Account   : ${YB} $vmess${NC}
       ${GB}Vless Account   : ${RB} $vless${NC}
       ${GB}Trojan Account  : ${YB} $trojan${NC}
       ${GB}Sodosok Account : ${RB} $ss${NC}
  ${BB}————————————————————————————————${NC}
    1. ${CB}Vmess Menu${NC}    4. ${CB}SS Menu${NC}
    2. ${CB}Vless Menu${NC}    5. ${CB}Bot Menu${NC}
    3. ${CB}Trojan Menu${NC}   6. ${CB}Other Menu${NC}
  ${BB}————————————————————————————————${NC}
        Expired : ${GB}$expiry_date $Admin ${NC}
        Sisa Hari: ${GB}$remaining_days$Admin ${NC}
  ${BB}————————————————————————————————${NC}
       ${MB}Autoscript Mod By San${NC}
                  $uptime_info
  ${BB}————————————————————————————————${NC}
"
echo -e "$LAYOUT"    
read -p " Select Menu :  " opt
case $opt in
    1) clear ; vmessmenu ;;
    2) clear ; vlessmenu ;;
    3) clear ; trojanmenu ;;
    4) clear ; sodosokmenu ;;
    5) clear ; echo -e "Comming Soon" ;;
    6) clear ; settingmenu ;;
    *) echo -e "${YB}Invalid input${NC}" ; sleep 1 ; menu ;;
esac
